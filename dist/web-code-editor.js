!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebCodeEditor=t():e.WebCodeEditor=t()}(this,(function(){return(()=>{"use strict";var e={355:(e,t,s)=>{function i(e,t={}){const s=document.createElement(e);if(t.id&&(s.id=t.id),t.className&&(s.className=t.className),t.textContent&&(s.textContent=t.textContent),t.innerHTML&&(s.innerHTML=t.innerHTML),t.style&&Object.assign(s.style,t.style),t.attrs&&Object.assign(s,t.attrs),t.click&&s.addEventListener("click",(e=>t.click(e))),t.parent&&t.parent.append(s),t.children&&t.children.forEach((e=>s.append(e))),t.events)for(const e in t.events)s.addEventListener(e,t.events[e]);return s}s.r(t),s.d(t,{WebCodeEditor:()=>P});const n="web-code-editor",r="pane1",h="pane2",a="pane3",l="active",o="editor-container",c="editor-textarea",d="title-tabs",p="custom-codeMirror",u="item",m="close-icon",w="open",f="mask",g="item create",b="right-menu",v="divide",y="item",x="item",k="item dir",E="msg",M="field",C="files",D="image-container",T="image",L="open-dir-btn",N="new-is-invalid",O={openFolder:"打开文件夹",selectFolder:"选择文件夹",close:"关闭",closeAll:"全部关闭",closeOther:"全部其它",closeRight:"关闭到右侧",openRight:"右侧打开",delete:"删除",newFile:"新建文件",newDir:"新建文件夹",errMeg:"必须提供文件或文件名",save:"保存"};class F{constructor(){this.listeners=[];const{writable:e,readable:t}=new TransformStream;this.w$=e.getWriter(),this.r$=t.getReader(),this._listener()}async _listener(){for(;;){const{value:e,done:t}=await this.r$.read();if(t){this.listeners.filter((e=>e.complete)).forEach((e=>e.complete()));break}this.listeners.filter((e=>e.next)).forEach((t=>t.next(e)))}}subscribe(e){return"function"==typeof e&&(e={next:e}),this.listeners.push(e),()=>{const t=this.listeners.findIndex((t=>t===e));this.listeners.splice(t,1)}}complete(){this.w$.close(),this.r$.cancel()}error(e){this.listeners.filter((e=>e.error)).forEach((t=>t.error(e)))}next(e){this.w$.write(e)}}class S{constructor(e){this.wce=e}show(...e){this.el.style.display="block"}hide(...e){this.el.style.display="none"}clear(...e){this.el.innerHTML=""}remove(){this.el.remove()}showMask(...e){return this.wce.mask.show(...e)}hideMask(...e){this.wce.mask.hide(...e)}evContextmenu(e){this.el.addEventListener("contextmenu",(t=>{t.preventDefault(),t.stopPropagation(),e&&("function"==typeof e?e(t):Array.isArray(e)&&this.wce.rightMenu.show(e,t.clientX,t.clientY))}))}evKeydown(e){this.el.addEventListener("keydown",(t=>{e(t)}))}evWheel(e){this.el.addEventListener("wheel",(t=>{e(t)}))}}class P{constructor(e,t,s){this.initCodeMirror=t;const r="string"==typeof e?function(e,t=document){return t.querySelector(e)}(e):e;if(!r)throw"not root container!";s?.staticText&&Object.assign(O,s.staticText),this.rootEl=i("div",{className:n,parent:r,events:{pointerup:()=>this.pane2.isDown=!1,mousemove:e=>{this.pane2.isDown&&(this.pane1.width=e.clientX)}}}),this.pane1=new $(this),this.pane2=new R(this),this.pane3=new z(this),this.mask=new I(this),this.rightMenu=new W(this)}get titleTabs(){return this.pane3.titleTabs}get codeMirror(){return this.pane3.codeContainer.codeMirror}async showDirectoryPicker(){try{this.addDir(await window.showDirectoryPicker())}catch(e){throw console.error(e),e}}async addDir(e){new B(this,e,this.pane1.menus,e)}}class $ extends S{constructor(e){super(e),this.el=i("div",{className:r,parent:this.wce.rootEl,attrs:{tabindex:0},events:{keydown:e=>{"Escape"===e.key&&(this.wce.mask.hide(),this.wce.rightMenu.hide())}}}),this.menus=i("ul",{className:C,parent:this.el}),this.openDirBtn=i("div",{className:L,textContent:O.openFolder,parent:this.el,click:e=>{e.stopPropagation(),this.clickBtn()}}),this.clickBtn=()=>{this.wce.showDirectoryPicker().then((()=>{this.hideBtn()}))},this.evContextmenu([{text:O.selectFolder,click:this.clickBtn}])}set width(e){this.el.style.width=e+"px"}get isEmptyDir(){return""===this.menus.innerHTML.trim()}showBtn(){this.openDirBtn.style.display="block"}hideBtn(){this.openDirBtn.style.display="none"}}class R extends S{constructor(e){super(e),this.isDown=!1,this.el=i("div",{className:h,parent:this.wce.rootEl,events:{pointerdown:()=>this.isDown=!0,pointerup:()=>this.isDown=!1}})}}class z extends S{constructor(e){super(e),this.el=i("div",{className:a,parent:this.wce.rootEl}),this.containerEl=i("section",{className:o,parent:this.el}),this.titleTabs=new A(this.wce,this.el),this.imageContainer=new K(this.wce,this.containerEl),this.codeContainer=new Y(this.wce,this.containerEl)}}class I extends S{constructor(e){super(e),this.close$=new F,this.el=i("div",{className:f,parent:e.rootEl,click:e=>{this.close$.next(e),this.hide()}}),this.evContextmenu((e=>{this.wce.rightMenu.move(e.clientX,e.clientY)}))}bg(e){return this.el.style.background=e,this}show(e){if(super.show(),e)return this.close$.subscribe(e)}}class W extends S{constructor(e){super(e),this.el=i("ul",{className:b,parent:e.rootEl}),this.evContextmenu(),this.wce.mask.close$.subscribe((()=>{this.hide()}))}show(e,t=0,s=0){this.clear();for(const t of e){i("li",{className:y+(t.divide?` ${v}`:""),innerHTML:`<span class="text">${t.text}</span>`,parent:this.el,click:e=>{this.hideMask(),this.hide(),t.click(e)}})}this.showMask(),super.show(),this.move(t,s)}move(e,t){this.el.style.left=e+"px",this.el.style.top=t+"px"}}class j extends S{constructor(e,t,s){super(e),this.hFile=t,this.dirMenu=s,this.menuClick=e=>{e.stopPropagation(),this.wce.titleTabs.add(this)},this.del=()=>{this.dirMenu.hDir.removeEntry(this.name).then((()=>{this.wce.titleTabs.closeTab(this),this.el.remove()}))},this.el=i("li",{className:x,innerHTML:`<span>${t.name}</span>`,parent:s.files,click:this.menuClick}),this.evContextmenu([{text:O.openRight,click:this.menuClick},{text:O.delete,click:this.del}])}async getType(){return this.file||(this.file=await this.hFile.getFile()),this.file.type}async getSize(){return this.file||(this.file=await this.hFile.getFile()),this.file.size}get name(){return this.hFile.name}}class V extends S{constructor(e,t,s=""){super(e.wce),this.dirMenu=e,this.msgEl=i("div",{className:E}),this.el=i("li",{className:g,parent:e.files,click:e=>e.stopPropagation()});const n=i("div",{className:M,parent:this.el,children:[this.msgEl]});this.input=i("input",{parent:n,attrs:{required:!0,value:s},events:{input:()=>this.showeErrMsg(),keydown:e=>{e.stopPropagation(),"Enter"===e.key&&(this.showeErrMsg(),this.isValid&&(t(this.value),this.hideMask(),this.remove(),this.unsubscribe())),"Escape"===e.key&&(this.hideMask(),this.remove(),this.unsubscribe())}}}),this.input.focus(),this.unsubscribe=this.showMask((()=>{this.isValid&&t(this.value),this.remove(),this.unsubscribe()}))}showeErrMsg(){this.isValid?this.msgEl.style.display="none":(this.msgEl.style.display="block",this.msgEl.textContent=O.errMeg)}get isValid(){const e=!!this.value.trim();return e?this.input.classList.remove(N):this.input.classList.add(N),e}get value(){return this.input.value}}class B extends S{constructor(e,t,s,n){super(e),this.hDir=t,this.parent=s,this.hParentDir=n,this.files=i("ul",{className:C}),this.isInit=!1,this.clickMenu=e=>{e.stopPropagation(),e.currentTarget===this.el&&this.toggle()},this.newFile=()=>{this.isOpen||(this.isOpen=!0),new V(this,(async e=>{const t=await this.hDir.getFileHandle(e,{create:!0}),s=new j(this.wce,t,this);this.wce.titleTabs.add(s),this.wce.codeMirror.focus()}))},this.newDir=()=>{this.isOpen||(this.isOpen=!0),new V(this,(async e=>{const t=await this.hDir.getDirectoryHandle(e,{create:!0});new B(this.wce,t,this.files,this.hDir)}))},this.delDir=()=>{this.el.remove(),this.wce.titleTabs.closeWithDir(this.hDir),this.isRootDir?this.wce.pane1.isEmptyDir&&this.wce.pane1.showBtn():this.hParentDir.removeEntry(this.name,{recursive:!0})},this.el=i("li",{className:k,innerHTML:`<span>${this.name}</span>`,parent:s,click:this.clickMenu,children:[this.files]}),this.evContextmenu([{text:O.newFile,click:this.newFile},{text:O.newDir,click:this.newDir},{text:this.isRootDir?O.close:O.delete,click:this.delDir}])}get isOpen(){return this.files.classList.contains(w)}set isOpen(e){e?(this.isInit||this.createChildren(),this.files.classList.add(w),this.el.classList.add(w)):(this.files.classList.remove(w),this.el.classList.remove(w))}toggle(){this.isOpen=!this.isOpen}get name(){return this.hDir.name}get isRootDir(){return this.hDir===this.hParentDir}async createChildren(){for await(const[e,t]of this.hDir)"directory"===t.kind?new B(this.wce,t,this.files,this.hDir):new j(this.wce,t,this);this.isInit=!0}}class H extends S{constructor(e,t){super(e.wce),this.tabs=e,this.fileMenu=t,this.isImage=!1,this.click=e=>{e.stopPropagation(),this.tabs.setCurrent(this)},this.close=e=>{e.stopPropagation(),this.tabs.closeTab(this.fileMenu)},this.el=i("li",{className:u,textContent:t.name,parent:e.el,click:this.click,children:[i("span",{className:m,textContent:"✖️",click:this.close})]}),this.evContextmenu([{text:O.save,click:()=>this.save(this.wce.codeMirror.getValue())},{divide:!0,text:O.close,click:this.close},{text:O.closeAll,click:e.closeAllTab},{text:O.closeOther,click:()=>e.closeOtherTab(this)},{text:O.closeRight,click:()=>e.closeRightTab(this)}])}get hFile(){return this.fileMenu.hFile}get isVisible(){const e=this.tabs.el,t=this.el;return t.offsetLeft>=e.scrollLeft&&t.offsetLeft+(t.clientWidth-20)<e.clientWidth+e.scrollLeft}async save(e){const t=await this.fileMenu.hFile.createWritable();await t.write(e),await t.close()}get isActive(){return this.el.classList.contains(l)}active(e){e?this.el.classList.add(l):this.el.classList.remove(l)}async text(){const e=await this.fileMenu.hFile.getFile();return this.isImage=e.type.includes("image"),this.isImage?window.URL.createObjectURL(e):await e.text()}}class A extends S{constructor(e,t){super(e),this.tabs=[],this.closeTab=e=>{const t=this.tabs.find((t=>t.fileMenu===e));if(!t)return;const s=this.tabs.indexOf(t);if(t.isActive){const e=this.nextTab(s);e?this.setCurrent(e):(this.wce.codeMirror.setValue(""),this.wce.pane3.imageContainer.hide(),this.wce.pane3.codeContainer.hide())}t.el.remove(),t.isImage&&this.wce.pane3.imageContainer.hide(),this.tabs.splice(s,1)},this.closeAllTab=()=>{this.tabs.forEach((e=>{e.el.remove()})),this.tabs=[],this.wce.pane3.imageContainer.hide(),this.wce.pane3.codeContainer.hide()},this.closeOtherTab=e=>{this.tabs.forEach((t=>{t!==e&&t.remove()})),this.tabs=[e],e.isImage&&this.wce.pane3.imageContainer.hide(),this.setCurrent(e)},this.closeRightTab=e=>{const t=this.tabs.indexOf(e);let s=!1;this.tabs.forEach(((e,i)=>{i>t&&(s=e.isActive,e.remove())})),this.tabs.splice(t+1,this.tabs.length),s&&this.setCurrent(this.last)},this.el=i("ul",{className:d,parent:t}),this.evContextmenu()}scrollToRight(){this.el.scrollTo({top:0,left:this.el.scrollWidth})}scrollToCurrent(){const e=this.current?.el.offsetLeft??0;this.el.scrollTo({top:0,left:e})}get last(){return this.tabs[this.tabs.length-1]}clear(){super.clear(),this.tabs=[],this.wce.codeMirror.setValue(""),this.wce.pane3.imageContainer.hide(),this.wce.pane3.codeContainer.hide()}async setCurrent(e){this.current=e,this.tabs.forEach((t=>t.active(t===e)));const t=await e.text();e.isImage?this.wce.pane3.imageContainer.show(t):(this.wce.pane3.imageContainer.hide(),this.wce.codeMirror.setValue(t)),e.isVisible||this.scrollToCurrent()}nextTab(e){return this.tabs[e+1]??this.tabs[e-1]??null}async closeWithDir(e){const t=[];for(const s of this.tabs){await e.resolve(s.hFile)&&t.push(s.fileMenu)}t.forEach((e=>this.closeTab(e)))}add(e){const t=this.tabs.find((t=>t.fileMenu===e));if(t)this.setCurrent(t);else{const t=new H(this,e);this.tabs.push(t),this.setCurrent(t)}}}class K extends S{constructor(e,t){super(e),this.imgEl=i("img"),this.imageEl=i("div",{className:T,children:[this.imgEl]}),this.scale=1,this.resize=e=>{e.stopPropagation(),e.ctrlKey&&(e.preventDefault(),this.scale+=-.001*e.deltaY,this.imgEl.style.transform=`scale(${this.scale})`)},this.reset=()=>{this.scale=1,this.imgEl.style.transform=`scale(${this.scale})`},this.el=i("div",{parent:t,className:D,children:[this.imageEl]}),this.evContextmenu(),this.listenerScaleImage()}listenerScaleImage(){this.imgEl.addEventListener("dblclick",this.reset),this.imageEl.addEventListener("wheel",this.resize),this.imgEl.addEventListener("wheel",this.resize)}show(e){this.imgEl.src=e,this.wce.pane3.codeContainer.hide(),super.show()}hide(){super.hide(),this.wce.pane3.codeContainer.show()}}class Y extends S{constructor(e,t){super(e),this.parent=t,this.code=i("code"),this.el=i("pre",{className:c,parent:this.parent,children:[this.code]}),this.codeMirror=e.initCodeMirror(this.code);const s=this.code.querySelector(".CodeMirror");if(!s)throw"not find CodeMirror.";s.classList.add(p),this.evKeydown((e=>{e.ctrlKey&&"KeyS"===e.code&&(e.preventDefault(),this.wce.titleTabs.current?.save(this.codeMirror.getValue()))})),this.fontSize=parseFloat(getComputedStyle(s).fontSize),this.evWheel((e=>{e.ctrlKey&&(e.preventDefault(),this.fontSize+=-.01*e.deltaY,this.fontSize=Math.max(12,this.fontSize),s.style.fontSize=`${this.fontSize}px`)}))}}}},t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={exports:{}};return e[i](n,n.exports,s),n.exports}return s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s(355)})()}));